<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reddit Phrase Monitor</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #fafafa;
  }
  #results {
    margin-top: 20px;
  }
  .match {
    background: #f0f0f0;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 6px;
    border-left: 4px solid #0079d3;
  }
  .match a {
    font-size: 1.1em;
    color: #0079d3;
    text-decoration: none;
  }
  .match a:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<h1>Reddit Exact-Phrase Monitor</h1>
<pre id="debug" style="white-space: pre-wrap; background:#fff; border:none;"></pre>
<div id="results"></div>

<script>
const subreddits = [
  "kanban",
  "SoftwareEngineering",
  "softwaredevelopment",
  "EngineeringManagers",
  "ExperiencedDevs",
  "agile"
];
const phrases = [
  "Queueing Theory", "Little's Law", "WIP", "cycle time", "lead time", "throughput", " Lean",
  " metric",
  " estimation", " estimates", " estimate", "noestimates",
  "TDD", "test-driven", "test driven", "BDD", "test-first", "test first", "test-after", "test after",
  " refactor",
  " kata",
  "bug policy",
  "bug age", "age of open bugs"
];

function salvageRedditListing(text) {
  try { // Try normal parse first
    return JSON.parse(text);
  } catch {}

  // Find the children array
  const start = text.indexOf('"children":');
  if (start === -1) return { data: { children: [] } };

  const arrayStart = text.indexOf('[', start);
  if (arrayStart === -1) return { data: { children: [] } };

  const after = text.slice(arrayStart + 1);

  // Split on "}," boundaries â€” each child is an object
  const parts = after.split('},');
  const children = [];

  for (let i = 0; i < parts.length; i++) {
    let candidate = parts[i];

    // Add back the missing brace except for the last one
    if (i < parts.length - 1) {
      candidate = candidate + '}';
    }
    try {
      const obj = JSON.parse(candidate);
      children.push(obj);
    } catch {
      break; // stop at first broken object
    }
  }
  return { data: { children } };
}
  
async function fetchSubreddit(sub) {
  const url = `https://fetcher.wnhanlon-github.workers.dev/${sub}`;

  try {

    // document.getElementById("debug").textContent += `Fetching: ${url}\n`;
    
    const res = await fetch(url, {
      headers: {
        "Accept": "application/json"
      }
    });
    // const json = await res.json(); // doesn't handle partial json returned from Reddit
    const text = await res.text();
    const json = salvageRedditListing(text);

    return json.data.children.map(c => ({
      ...c.data,
      subreddit: sub
    }));

  } catch (err) {
    console.error("Error fetching", sub, err);
    const dbg = document.getElementById("debug");
    dbg.textContent += `\nError fetching ${sub}: ${err}\n`;
    return [];
  }
}

function matchesPhrase(post, phrase) {
  const body = post.selftext || "";
  const text = (post.title + "\n" + body).toLowerCase();
  return text.includes(phrase.toLowerCase());
}

function writeMatchToDOM(post, phrase) {
  const container = document.getElementById("results");

  const div = document.createElement("div");
  div.className = "match";

  div.innerHTML = `
    <p><strong>Match:</strong> ${phrase} in <strong>r/${post.subreddit}</strong></p>
    <a href="https://www.reddit.com${post.permalink}" target="_blank">
      ${post.title}
    </a>
    <p><small>Posted by <strong>u/${post.author}</strong>&nbsp;${new Date(post.created_utc * 1000).toLocaleString()}</small></p>
  `;

  container.appendChild(div);
}

async function runOnce() {

  debugger;

  // Fetch all subreddits in parallel
  const allResults = await Promise.all(subreddits.map(fetchSubreddit));

  // Flatten into one array
  const allPosts = allResults.flat();

  // Sort newest first
  allPosts.sort((a, b) => b.created_utc - a.created_utc);

  // Scan for matches
  for (const post of allPosts) {
    for (const phrase of phrases) {
      if (matchesPhrase(post, phrase)) {
        writeMatchToDOM(post, phrase);
        break;
      }
    }
  }
}

runOnce();
</script>

</body>
</html>
