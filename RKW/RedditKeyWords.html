<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reddit Phrase Monitor</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #fafafa;
  }
  #results {
    margin-top: 20px;
  }
  .match {
    background: #f0f0f0;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 6px;
    border-left: 4px solid #0079d3;
  }
  .match a {
    font-size: 1.1em;
    color: #0079d3;
    text-decoration: none;
  }
  .match a:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<h1>Reddit Exact-Phrase Monitor</h1>
<p>Running once. Matches will appear below.</p>
  
<div id="results"></div>

<pre id="debug" style="white-space: pre-wrap; background:#fee; padding:10px; border:1px solid #c00;"></pre>

<script>
const subreddits = [
  "kanban",
  "ExperiencedDevs",
  "agile"
];
const phrases = [
  "Queueing Theory", "Little's Law", "WIP", "cycle time", "lead time", "throughput",
  "Lean",
  "bug",
  "estimation", "estimates", "estimate"
];

async function fetchSubreddit(sub) {
  const url = `https://fetcher.wnhanlon-github.workers.dev/${sub}`;

  try {

    // document.getElementById("debug").textContent += `Fetching: ${url}\n`;
    
    const res = await fetch(url, {
      headers: {
        "Accept": "application/json"
      }
    });
    const json = await res.json();

    return json.data.children.map(c => ({
      ...c.data,
      subreddit: sub
    }));

  } catch (err) {
    console.error("Error fetching", sub, err);
    const dbg = document.getElementById("debug");
    dbg.textContent += `\nError fetching ${sub}: ${err}\n`;
    return [];
  }
}

function matchesPhrase(post, phrase) {
  const body = post.selftext || "";
  const text = (post.title + "\n" + body).toLowerCase();
  return text.includes(phrase.toLowerCase());
}

function writeMatchToDOM(post, phrase) {
  const container = document.getElementById("results");

  const div = document.createElement("div");
  div.className = "match";

  div.innerHTML = `
    <p><strong>Match:</strong> "${phrase}" in <strong>r/${post.subreddit}</strong></p>
    <a href="https://www.reddit.com${post.permalink}" target="_blank">
      ${post.title}
    </a>
    <p><small>${new Date(post.created_utc * 1000).toLocaleString()}</small></p>
  `;

  container.appendChild(div);
}

async function runOnce() {

  debugger;

  // Fetch all subreddits in parallel
  const allResults = await Promise.all(subreddits.map(fetchSubreddit));

  // Flatten into one array
  const allPosts = allResults.flat();

  // Sort newest first
  allPosts.sort((a, b) => b.created_utc - a.created_utc);

  // Scan for matches
  for (const post of allPosts) {
    for (const phrase of phrases) {
      if (matchesPhrase(post, phrase)) {
        writeMatchToDOM(post, phrase);
        break;
      }
    }
  }
}

runOnce();
</script>

</body>
</html>
